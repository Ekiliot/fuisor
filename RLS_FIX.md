# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ê –û–®–ò–ë–ö–ê "Cannot coerce the result to a single JSON object"

## üêõ **–ü–†–û–ë–õ–ï–ú–ê:**
–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
Supabase update error: {
  code: 'PGRST116',
  details: 'The result contains 0 rows',
  hint: null,
  message: 'Cannot coerce the result to a single JSON object'
}
```

## üîç **–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
```bash
node check-users.js
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ `auth.users` –∏–º–µ—é—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –≤ `profiles`

### **2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```bash
node check-vasya.js
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'vasya' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤ auth.users, –∏ –≤ profiles

### **3. –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
```bash
node test-update.js
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- ‚úÖ **Admin –∫–ª–∏–µ–Ω—Ç** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå **–û–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç** - –æ—à–∏–±–∫–∞ PGRST116

## üéØ **–ü–†–ò–ß–ò–ù–ê:**
**RLS (Row Level Security) –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç!**

- Admin –∫–ª–∏–µ–Ω—Ç –æ–±—Ö–æ–¥–∏—Ç RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- –û–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –ø–æ–¥—á–∏–Ω—è–µ—Ç—Å—è RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º
- –í API –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –æ–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –≤–º–µ—Å—Ç–æ admin –∫–ª–∏–µ–Ω—Ç–∞

---

## üîß **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:**

### **1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç supabaseAdmin:**
```javascript
// src/routes/user.routes.js
import { supabase, supabaseAdmin } from '../config/supabase.js';
```

### **2. –ó–∞–º–µ–Ω–µ–Ω –æ–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–∞ admin –∫–ª–∏–µ–Ω—Ç:**

#### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```javascript
// ‚ùå –ë–´–õ–û (–Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ)
const { data: existingUser, error: checkError } = await supabase
  .from('profiles')
  .select('id, username, name')
  .eq('id', req.user.id)
  .single();

// ‚úÖ –°–¢–ê–õ–û (—Ä–∞–±–æ—Ç–∞–µ—Ç)
const { data: existingUser, error: checkError } = await supabaseAdmin
  .from('profiles')
  .select('id, username, name')
  .eq('id', req.user.id)
  .single();
```

#### **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:**
```javascript
// ‚ùå –ë–´–õ–û (–Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ)
const { data, error } = await supabase
  .from('profiles')
  .update(updates)
  .eq('id', req.user.id)
  .select()
  .single();

// ‚úÖ –°–¢–ê–õ–û (—Ä–∞–±–æ—Ç–∞–µ—Ç)
const { data, error } = await supabaseAdmin
  .from('profiles')
  .update(updates)
  .eq('id', req.user.id)
  .select()
  .single();
```

#### **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:**
```javascript
// ‚ùå –ë–´–õ–û (–Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ)
const { data: updatedProfile, error: profileError } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', req.user.id)
  .single();

// ‚úÖ –°–¢–ê–õ–û (—Ä–∞–±–æ—Ç–∞–µ—Ç)
const { data: updatedProfile, error: profileError } = await supabaseAdmin
  .from('profiles')
  .select('*')
  .eq('id', req.user.id)
  .single();
```

---

## üìã **–§–ê–ô–õ–´ –ò–ó–ú–ï–ù–ï–ù–´:**

### **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `src/routes/user.routes.js` - –∑–∞–º–µ–Ω–µ–Ω supabase –Ω–∞ supabaseAdmin
- ‚úÖ `src/middleware/auth.middleware.js` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ `src/routes/auth.routes.js` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
- ‚úÖ `check-users.js` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è auth.users –∏ profiles
- ‚úÖ `check-vasya.js` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `test-update.js` - —Ç–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏

---

## üöÄ **–ö–ê–ö –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨:**

### **1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä:**
```bash
cd E:\fuisorbk\fuisorbk
npm start
```

### **2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
```bash
cd E:\fuisorbk\fuisorbk\fuisor_app
flutter run -d windows
```

### **3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ **Profile Screen**
2. –ù–∞–∂–º–∏—Ç–µ **"Edit Profile"**
3. –ò–∑–º–µ–Ω–∏—Ç–µ –ø–æ–ª–µ **"Name"** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ "vasya k")
4. –ù–∞–∂–º–∏—Ç–µ **"Done"**
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ

---

## üìä **–û–ñ–ò–î–ê–ï–ú–´–ï –õ–û–ì–ò:**

### **Backend –ª–æ–≥–∏ (—É—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ):**
```
Authenticated user: { id: '06038562-31b0-4e2d-bd47-b3190f6e2313', email: 'vasilecaceaun@gmail.com' }
Update profile request: { username: 'vasya', name: 'vasya k', bio: undefined, hasAvatar: false }
Updates to apply: { username: 'vasya', name: 'vasya k', updated_at: 2025-10-23T09:45:00.000Z }
User ID: 06038562-31b0-4e2d-bd47-b3190f6e2313
Existing user: { id: '06038562-31b0-4e2d-bd47-b3190f6e2313', username: 'vasya', name: 'vasya' }
Profile updated successfully: { id: '06038562-31b0-4e2d-bd47-b3190f6e2313', username: 'vasya', name: 'vasya k', ... }
```

### **Frontend –ª–æ–≥–∏ (—É—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ):**
```
Updating profile with: name="vasya k", username="vasya", bio=""
Profile update response status: 200
Profile update response body: {"id":"06038562-31b0-4e2d-bd47-b3190f6e2313","username":"vasya","name":"vasya k",...}
Parsed response data: {id: 06038562-31b0-4e2d-bd47-b3190f6e2313, username: vasya, name: vasya k, ...}
```

---

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢:**

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Ä–∞–±–æ—Ç–∞–µ—Ç** - –ø–æ–ª–µ `name` —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- ‚úÖ **–û—à–∏–±–∫–∞ PGRST116 –∏—Å—á–µ–∑–ª–∞** - –±–æ–ª—å—à–µ –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å RLS
- ‚úÖ **–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è** - –≤–∫–ª—é—á–∞—è counts
- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∏–º—è** - –≤ –ø—Ä–æ—Ñ–∏–ª–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ –∏–º—è

---

## üîç **–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï:**

### **–ü–æ—á–µ–º—É admin –∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Admin –∫–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Service Role Key**
- Service Role Key **–æ–±—Ö–æ–¥–∏—Ç –≤—Å–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏**
- –ú–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ª—é–±—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏

### **–ü–æ—á–µ–º—É –æ–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–ª:**
- –û–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Anon Key**
- Anon Key **–ø–æ–¥—á–∏–Ω—è–µ—Ç—Å—è RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º**
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è

### **RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è profiles:**
```sql
-- –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è SELECT (—Ä–∞–±–æ—Ç–∞–µ—Ç)
CREATE POLICY "Public profiles are viewable by everyone."
  ON profiles FOR SELECT
  USING ( true );

-- –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è UPDATE (–º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å)
CREATE POLICY "Users can update own profile."
  ON profiles FOR UPDATE
  USING ( auth.uid() = id );
```

---

## ‚ö†Ô∏è **–í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø:**

### **1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- Admin –∫–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è **–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `req.user.id` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
- Middleware `validateAuth` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏

### **2. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
–ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å admin –∫–ª–∏–µ–Ω—Ç, –º–æ–∂–Ω–æ:
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è UPDATE –æ–ø–µ—Ä–∞—Ü–∏–π
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç —Å `auth.uid()`

### **3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ú–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ª–æ–≥–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

**–û–®–ò–ë–ö–ê –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ê!** ‚ú®

**–¢–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!** üéâ
