# ‚úÖ –°–û–•–†–ê–ù–ï–ù–ò–ï –°–ï–°–°–ò–ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò –†–ï–ê–õ–ò–ó–û–í–ê–ù–û!

## üéØ **–ß–¢–û –°–î–ï–õ–ê–ù–û:**

### **‚úÖ Persistent Authentication:**
- **SharedPreferences** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** - —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π logout** - –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ

---

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:**

### **1. AuthProvider –æ–±–Ω–æ–≤–ª–µ–Ω:**

#### **–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è:**
```dart
class AuthProvider extends ChangeNotifier {
  bool _isInitialized = false;  // ‚úÖ –ù–û–í–û–ï
  
  // –ö–ª—é—á–∏ –¥–ª—è SharedPreferences
  static const String _accessTokenKey = 'access_token';     // ‚úÖ –ù–û–í–û–ï
  static const String _refreshTokenKey = 'refresh_token';   // ‚úÖ –ù–û–í–û–ï
  static const String _userDataKey = 'user_data';           // ‚úÖ –ù–û–í–û–ï
}
```

#### **–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```dart
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
Future<void> _saveSession(String accessToken, String refreshToken, User user) async {
  final prefs = await SharedPreferences.getInstance();
  await prefs.setString(_accessTokenKey, accessToken);
  await prefs.setString(_refreshTokenKey, refreshToken);
  await prefs.setString(_userDataKey, jsonEncode(user.toJson()));
  _apiService.setAccessToken(accessToken);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏
Future<void> _loadSession() async {
  final prefs = await SharedPreferences.getInstance();
  final accessToken = prefs.getString(_accessTokenKey);
  final userDataString = prefs.getString(_userDataKey);

  if (accessToken != null && userDataString != null) {
    _apiService.setAccessToken(accessToken);
    final userData = jsonDecode(userDataString);
    _currentUser = User.fromJson(userData);
  }
  _isInitialized = true;
}

// –û—á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–∏
Future<void> _clearSession() async {
  final prefs = await SharedPreferences.getInstance();
  await prefs.remove(_accessTokenKey);
  await prefs.remove(_refreshTokenKey);
  await prefs.remove(_userDataKey);
  _apiService.setAccessToken(null);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
Future<void> initialize() async {
  if (_isInitialized) return;
  await _loadSession();
}
```

### **2. –û–±–Ω–æ–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã login/logout:**

#### **Login —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º:**
```dart
Future<bool> login(String emailOrUsername, String password) async {
  final authResponse = await _apiService.login(emailOrUsername, password);
  _currentUser = authResponse.profile ?? authResponse.user;
  
  // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
  await _saveSession(
    authResponse.accessToken,
    authResponse.refreshToken,
    _currentUser!,
  );
  
  return true;
}
```

#### **Logout —Å –æ—á–∏—Å—Ç–∫–æ–π:**
```dart
Future<void> logout() async {
  await _apiService.logout();
  
  // ‚úÖ –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
  await _clearSession();
  
  _currentUser = null;
  notifyListeners();
}
```

### **3. Main.dart –æ–±–Ω–æ–≤–ª–µ–Ω:**

#### **AuthWrapper –≤–∏–¥–∂–µ—Ç:**
```dart
class AuthWrapper extends StatefulWidget {
  @override
  void initState() {
    super.initState();
    // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º AuthProvider –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<AuthProvider>().initialize();
    });
  }

  @override
  Widget build(BuildContext context) {
    return Consumer<AuthProvider>(
      builder: (context, authProvider, child) {
        // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø–æ–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
        if (!authProvider.isInitialized) {
          return const Scaffold(
            backgroundColor: Color(0xFF000000),
            body: Center(
              child: CircularProgressIndicator(
                color: Color(0xFF0095F6),
              ),
            ),
          );
        }
        
        // ‚úÖ –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–∫—Ä–∞–Ω
        if (authProvider.isAuthenticated) {
          return const MainScreen();
        } else {
          return const LoginScreen();
        }
      },
    );
  }
}
```

### **4. ApiService –æ–±–Ω–æ–≤–ª–µ–Ω:**

#### **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ null —Ç–æ–∫–µ–Ω–æ–≤:**
```dart
void setAccessToken(String? token) {  // ‚úÖ –¢–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç null
  _accessToken = token;
}
```

---

## üöÄ **–ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢:**

### **1. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ:**
1. **AuthWrapper** –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
2. **AuthProvider.initialize()** –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
3. **SharedPreferences** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏
4. –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –Ω–∞–π–¥–µ–Ω–∞ - **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π login**
5. –ï—Å–ª–∏ —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç - **–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è LoginScreen**

### **2. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º login:**
1. **–¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** –≤ SharedPreferences
2. **–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
3. **ApiService –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω** –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º**

### **3. –ü—Ä–∏ logout:**
1. **–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–∞—é—Ç—Å—è** –∏–∑ SharedPreferences
2. **–¢–æ–∫–µ–Ω —É–¥–∞–ª—è–µ—Ç—Å—è** –∏–∑ ApiService
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ—Ç—Å—è**

### **4. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
1. **–°–µ—Å—Å–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è**
2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º**
3. **API –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º

---

## üì± **–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –û–ü–´–¢:**

### **–î–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
- ‚ùå **–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ** - –Ω—É–∂–Ω–æ –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ
- ‚ùå **–ü–æ—Ç–µ—Ä—è —Å–µ—Å—Å–∏–∏** –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚ùå **–ù–µ—É–¥–æ–±—Å—Ç–≤–æ** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### **–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
- ‚úÖ **–û–¥–∏–Ω —Ä–∞–∑ –∑–∞–ª–æ–≥–∏–Ω–∏–ª—Å—è** - –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ **–£–¥–æ–±—Å—Ç–≤–æ** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø** –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é

---

## üîí **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:**

### **1. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ:**
- ‚úÖ **SharedPreferences** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- ‚úÖ **–¢–æ–∫–µ–Ω—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è** –ø–æ —Å–µ—Ç–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
- ‚úÖ **–î–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã** —Å–∏—Å—Ç–µ–º–æ–π Android/iOS

### **2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏:**
- ‚úÖ **Access Token** - –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **Refresh Token** - –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ (–≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** –ø—Ä–∏ logout

### **3. –í–∞–ª–∏–¥–∞—Ü–∏—è:**
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è** —Ç–æ–∫–µ–Ω–æ–≤ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Å—Å–∏–∏
- ‚úÖ **Fallback –Ω–∞ LoginScreen** –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

---

## üìã **–§–ê–ô–õ–´ –ò–ó–ú–ï–ù–ï–ù–´:**

### **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `fuisor_app/lib/providers/auth_provider.dart` - –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- ‚úÖ `fuisor_app/lib/main.dart` - –¥–æ–±–∞–≤–ª–µ–Ω AuthWrapper –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ `fuisor_app/lib/services/api_service.dart` - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ null —Ç–æ–∫–µ–Ω–æ–≤

### **–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ **Persistent Authentication** - —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- ‚úÖ **Auto Login** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- ‚úÖ **Session Management** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–µ–π
- ‚úÖ **Secure Storage** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

---

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢:**

### **‚úÖ –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥** - –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø** - –Ω–µ –Ω—É–∂–Ω–æ –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑
- **–£–¥–æ–±—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** - –∫–∞–∫ –≤ –Ω–∞—Å—Ç–æ—è—â–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö

### **‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:**
- **–û–¥–∏–Ω —Ä–∞–∑ –∑–∞–ª–æ–≥–∏–Ω–∏–ª—Å—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø** –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
- **–ù–µ –Ω—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å** –∫–∞–∂–¥—ã–π —Ä–∞–∑
- **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## üîÑ **–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:**

### **1. Refresh Token (–≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏):**
```dart
// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
Future<void> _refreshToken() async {
  // –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
}
```

### **2. Session Timeout:**
```dart
// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π logout —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è
Timer? _sessionTimer;
```

### **3. Biometric Authentication:**
```dart
// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥ –ø–æ –æ—Ç–ø–µ—á–∞—Ç–∫—É/–ª–∏—Ü—É
Future<bool> authenticateWithBiometrics() async {
  // –õ–æ–≥–∏–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
}
```

---

**–°–û–•–†–ê–ù–ï–ù–ò–ï –°–ï–°–°–ò–ò –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û!** ‚ú®

**–¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º–∏ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏!** üîê
